<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu</title>
</head>
<body>
    <h2>Menu</h2>
    <table border="1">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Price</th>
                <th>Available</th>
                <th>Note</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="menuTableBody">
            <!-- Menu items will be dynamically populated here -->
        </tbody>
    </table>

    <button onclick="createOrder()">Create Order</button>

    <script>
        let currentTableId = localStorage.getItem('selectedTableId'); // Retrieve table_id from localStorage
        let orderItems = []; // Array to store selected items for the order

        // Fetch menu items from the API
        async function fetchMenu() {
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                alert('Access token not found. Please log in.');
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch('http://localhost:8000/menu', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch menu.');
                }

                const menuItems = await response.json();
                populateMenuTable(menuItems);
            } catch (error) {
                console.error('Error fetching menu:', error);
                alert('Failed to create order. Please try again.');
            }
        }

        // Populate the menu table
        function populateMenuTable(menuItems) {
            const tbody = document.getElementById('menuTableBody');
            tbody.innerHTML = ''; // Clear existing rows

            menuItems.forEach(item => {
                // Ensure price is a number
                const price = parseFloat(item.price); // Convert price to a number
                if (isNaN(price)) {
                    console.error(`Invalid price for item ID ${item.id}: ${item.price}`);
                    return; // Skip invalid items
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>$${price.toFixed(2)}</td>
                    <td>${item.is_available ? 'Yes' : 'No'}</td>
                    <td><input type="text" id="note-${item.id}" placeholder="Optional note"></td>
                    <td>
                        <button onclick="addItemToOrder(${item.id}, '${item.name}')">Add to Order</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Add an item to the order
        function addItemToOrder(itemId, itemName) {
            // Get the note for this specific item
            const noteInput = document.getElementById(`note-${itemId}`);
            const note = noteInput.value.trim(); // Trim whitespace

            const quantity = 1; // Default quantity is 1

            // Check if the item is already in the order
            const existingItem = orderItems.find(item => item.item_id === itemId);
            if (existingItem) {
                existingItem.quantity += 1; // Increment quantity if already added
            } else {
                // Add new item to the order
                orderItems.push({
                    item_id: itemId,
                    quantity: quantity,
                    note: note || null // Add note if provided
                });
            }

            alert(`Added "${itemName}" to the order.`);
            noteInput.value = ''; // Clear the note input
        }

        // Create the order
        async function createOrder() {
            if (orderItems.length === 0) {
                alert('Please add at least one item to the order.');
                return;
            }

            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                alert('Access token not found. Please log in.');
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch('http://localhost:8000/orders', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        table_id: parseInt(currentTableId),
                        order_items: orderItems
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create order.');
                }

                alert('Order created successfully!');
                orderItems = []; // Clear the order items
                window.location.href = 'table.html'; // Redirect back to the table page
            } catch (error) {
                console.error('Error creating order:', error);
                alert('Failed to create order. Please try again.');
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            if (!currentTableId) {
                alert('No table selected. Please go back and select a table.');
                window.location.href = 'table.html';
                return;
            }

            fetchMenu();
        });
    </script>
</body>
</html>